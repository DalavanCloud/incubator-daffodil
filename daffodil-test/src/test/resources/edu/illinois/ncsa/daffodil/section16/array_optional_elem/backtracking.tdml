<?xml version="1.0"?>
<tdml:testSuite suiteName="backtracking" description="Tests of proper backtracking behavior"
  xmlns:tdml="http://www.ibm.com/xmlns/dfdl/testData"
  xmlns:dfdl="http://www.ogf.org/dfdl/dfdl-1.0/"
  xmlns:xs="http://www.w3.org/2001/XMLSchema" 
  xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
  xmlns:ex="http://example.com">

  <tdml:defineSchema name="s">

    <xsd:include schemaLocation="xsd/built-in-formats.xsd" />

    <!-- Must be utf-8, or it chooses the other backend which does more copying and so doesn't show up the bug. -->
    <dfdl:format ref="ex:daffodilTest1" encoding="UTF-8" lengthKind="delimited" />

    <xsd:element name="A">
      <xsd:complexType>
        <xsd:sequence dfdl:separator="//%NL;"
          dfdl:separatorPosition="postfix">
          <xsd:element name="S">
            <xsd:complexType>
              <xsd:sequence dfdl:separator="//%NL;">
                <xsd:element name="C" type="xsd:string"
                  dfdl:initiator="C" />
                <xsd:element name="LS" maxOccurs="10"
                  dfdl:occursCountKind="implicit">
                  <xsd:complexType>
                    <xsd:sequence dfdl:separator="//%NL;">
                      <xsd:element name="L" dfdl:initiator="L">
                        <xsd:complexType>
                          <xsd:sequence dfdl:separator="/"
                            dfdl:separatorPosition="prefix">
                            <xsd:choice>
                              <xsd:element name="W" type="xsd:string" />
                              <xsd:element name="X" type="xsd:string" />
                            </xsd:choice>
                          </xsd:sequence>
                        </xsd:complexType>
                      </xsd:element>
                    </xsd:sequence>
                  </xsd:complexType>
                </xsd:element>
              </xsd:sequence>
            </xsd:complexType>
          </xsd:element>
          <xsd:element name="T" type="xsd:string" dfdl:initiator="T" />
        </xsd:sequence>
      </xsd:complexType>
    </xsd:element>
  </tdml:defineSchema>

  <!-- Illustrates that if we turn off copying of Instream (line 258 of InStream.scala), then there is a problem with backtracking -->
  <tdml:parserTestCase name="backtrack1Text" model="s" root="A">
    <tdml:document><![CDATA[C/c//
L/W//
T/t//
]]></tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <A>
          <S>
            <C>/c</C>
            <LS>
              <L>
                <W>W
                </W>
              </L>
            </LS>
          </S>
          <T>/t</T>
        </A>
      </tdml:dfdlInfoset>
    </tdml:infoset>


  </tdml:parserTestCase>

</tdml:testSuite>
