<?xml version="1.0" encoding="UTF-8"?>
<tdml:testSuite suiteName="Discriminator" description="Section 7 - Discriminator"
	xmlns:ex="http://example.com" xmlns="http://example.com"
	xmlns:tdml="http://www.ibm.com/xmlns/dfdl/testData" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:dfdl="http://www.ogf.org/dfdl/dfdl-1.0/" xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xmlns:ct="http://w3.ibm.com/xmlns/dfdl/ctInfoset" xsi:schemaLocation="http://www.ibm.com/xmlns/dfdl/testData /xsd/tdml.xsd">
	
	<tdml:defineSchema name="choice1">
		<dfdl:format ref="ex:daffodilTest1" />
		<xs:element name="c1">
			<xs:complexType>
				<xs:sequence>
					<xs:element name="c">
						<xs:complexType>
							<xs:choice>
								<xs:element name="a1">
									<xs:complexType>
										<xs:sequence>
											<xs:element name="e1" type="xs:int"
												dfdl:initiator="4" dfdl:lengthKind="explicit" dfdl:length="2">
												<xs:annotation>
													<xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
														<dfdl:discriminator testKind="pattern"
																			testPattern="44" message="discriminator failed for pattern '44'" />
													</xs:appinfo>
												</xs:annotation>
											</xs:element>
											<xs:element name="e2" type="xs:string"
												dfdl:lengthKind="explicit" dfdl:length="6" dfdl:lengthUnits="characters" />
										</xs:sequence>
									</xs:complexType>
								</xs:element>
								<xs:element name="a2" type="xs:string"
									dfdl:lengthKind="explicit" dfdl:initiator="k" dfdl:length="5" dfdl:lengthUnits="characters" />
							</xs:choice>
						</xs:complexType>
					</xs:element>
				</xs:sequence>
			</xs:complexType>
		</xs:element>
		<xs:element name="c2">
			<xs:complexType>
				<xs:sequence>
					<xs:element name="c">
						<xs:complexType>
							<xs:choice>
								<xs:element name="a1">
									<xs:complexType>
										<xs:sequence>
											<xs:element name="e1" type="xs:int"
												dfdl:initiator="4" dfdl:lengthKind="explicit" dfdl:length="2">
											</xs:element>
											<xs:element name="e2" type="xs:string"
												dfdl:lengthKind="explicit" dfdl:length="6" dfdl:lengthUnits="characters" />
										</xs:sequence>
									</xs:complexType>
								</xs:element>
								<xs:element name="a2" type="xs:string"
									dfdl:lengthKind="explicit" dfdl:initiator="k" dfdl:length="5" dfdl:lengthUnits="characters" />
							</xs:choice>
						</xs:complexType>
					</xs:element>
				</xs:sequence>
			</xs:complexType>
		</xs:element>
	</tdml:defineSchema>

<!--
	Test name: discriminatorGuidesChoice2
	   Schema: choice1, root c1
	  Purpose: For the first element of the choice (a1), this document does not meet the criteria for element 1
			   or the discriminator for element 1, so element 2 shouldn't even be checked. The document doesn't
			   meet the criteria for the second element of the choice (a2) either and should fail. 
-->
	
	<tdml:parserTestCase name="discriminatorGuidesChoice2"
		root="c1" model="choice1"
		description="Section 7 - Discriminator must evaluate even if element fails">
		<tdml:document>324OHI</tdml:document>
		<tdml:errors>
			<tdml:error>Parse Error: All alternatives failed</tdml:error>
		</tdml:errors>
	</tdml:parserTestCase>

<!--
	Test name: discriminatorGuidesChoice3
	   Schema: choice1, root c2
	  Purpose: For the first element of the choice (a1), this document does not meet the criteria for element 1,
			   but does meet criteria for element 2. The document should be parsed accordingly. 
-->
	
	<tdml:parserTestCase name="discriminatorGuidesChoice3"
		root="c2" model="choice1"
		description="Section 7 - Discriminator must evaluate even if element fails">
		<tdml:document>324OHI</tdml:document>
		<tdml:infoset>
			<tdml:dfdlInfoset>
				<c2>
					<c>
						<a1>
							<e2>324OH</e2>
						</a1>
					</c>
				</c2>
			</tdml:dfdlInfoset>
		</tdml:infoset>
	</tdml:parserTestCase>

	<tdml:defineSchema name="choice2">
		<dfdl:format ref="ex:daffodilTest1" />
		<xs:element name="c1">
			<xs:complexType>
				<xs:sequence>
					<xs:element name="c">
						<xs:complexType>
							<xs:choice>
								<xs:element name="a1">

									<xs:complexType>
										<xs:sequence>
											<xs:annotation>
												<xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
													<dfdl:discriminator><![CDATA[{ true() }]]></dfdl:discriminator>
												</xs:appinfo>
											</xs:annotation>
											<xs:element name="str" type="xs:string"
												dfdl:lengthKind="explicit" dfdl:length="{ 80 }" /> <!-- fails because there is no data -->
										</xs:sequence>
									</xs:complexType>
								</xs:element>
								<xs:element name="a2" type="xs:string"
									dfdl:inputValueCalc="{ 'a2' }" />
							</xs:choice>
						</xs:complexType>
					</xs:element>
				</xs:sequence>
			</xs:complexType>
		</xs:element>

	</tdml:defineSchema>

	<tdml:defineSchema name="s1">
		<dfdl:format ref="ex:daffodilTest1" />
		<xs:element name="e1" type="xs:int" dfdl:lengthKind="delimited">
			<xs:annotation>
				<xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d" message="Discriminator failed for pattern '\d\d'" />
				</xs:appinfo>
			</xs:annotation>
		</xs:element>

		<xs:element name="e2" type="xs:int" dfdl:lengthKind="delimited">
			<xs:annotation>
				<xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d\d" message="Discriminator failed for pattern '\d\d\d'" />
				</xs:appinfo>
			</xs:annotation>
		</xs:element>

		<xs:element name="e3" type="xs:int" dfdl:lengthKind="pattern" dfdl:lengthPattern="\d\d" dfdl:terminator=": ,">
			<xs:annotation>
				<xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d" message="Discriminator failed for pattern '\d\d'" />
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d:" message="Discriminator failed for pattern '\d\d:'" />
				</xs:appinfo>
			</xs:annotation>
		</xs:element>
		
		<xs:element name="e4" type="xs:int" dfdl:lengthKind="pattern" dfdl:lengthPattern="\d\d" dfdl:terminator=": ,">
			<xs:annotation>
				<xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d" message="Discriminator failed for pattern '\d\d'" />
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d:" message="Discriminator failed for pattern '\d\d:'" />
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d" message="Discriminator failed for pattern '\d\d'" />
				</xs:appinfo>
			</xs:annotation>
		</xs:element>
		
		<xs:element name="e5" type="xs:int" dfdl:lengthKind="pattern" dfdl:lengthPattern="\d\d" dfdl:terminator=": ,">
			<xs:annotation>
				<xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
					<dfdl:assert testKind="pattern" testPattern="\d\d" message="Assertion failed for pattern '\d\d'"/>
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d" message="Discriminator failed for pattern '\d\d'" />
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d:" message="Discriminator failed for pattern '\d:'" />
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d" message="Discriminator failed for pattern '\d\d'" />
				</xs:appinfo>
			</xs:annotation>
		</xs:element>
		
		<xs:element name="e6" type="xs:int" dfdl:lengthKind="pattern" dfdl:lengthPattern="\d\d" dfdl:terminator=": ,">
			<xs:annotation>
				<xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
					<dfdl:assert testKind="pattern" testPattern="\d\d\d" message="Assertion failed for pattern '\d\d\d'"/>
					<dfdl:discriminator testKind="pattern"
						testPattern="\d\d:" message="Discriminator failed for pattern '\d\d:'" />
				</xs:appinfo>
			</xs:annotation>
		</xs:element>
	</tdml:defineSchema>

	<tdml:parserTestCase name="discriminatorGuidesChoice"
		root="c1" model="choice2"
		description="Section 7 - Discriminator with boolean test expression - DFDL-7-060R">
		<tdml:document />
		<tdml:errors>
			<tdml:error>Parse Error</tdml:error>
		</tdml:errors>
	</tdml:parserTestCase>

	<tdml:parserTestCase name="discrimPatternPass"
		root="e1" model="s1" description="Section 7 - discrim as a pattern - DFDL-7-045R">
		<tdml:document><![CDATA[43]]></tdml:document>
		<tdml:infoset>
			<tdml:dfdlInfoset>
				<e1>43</e1>
			</tdml:dfdlInfoset>
		</tdml:infoset>
	</tdml:parserTestCase>

	<tdml:parserTestCase name="discrimPatternFail"
		root="e2" model="s1" description="Section 7 - discrim as a pattern - DFDL-7-045R">
		<tdml:document><![CDATA[43]]></tdml:document>
		<tdml:errors>
			<tdml:error>Discrim</tdml:error>
			<tdml:error>pattern</tdml:error>
		</tdml:errors>
	</tdml:parserTestCase>
	
	<tdml:parserTestCase name="discrimPatternPass2"
		root="e3" model="s1" description="Section 7 - multiple discrim as a pattern - DFDL-7-045R">
		<tdml:document><![CDATA[43:]]></tdml:document>
		<tdml:infoset>
			<tdml:dfdlInfoset>
				<e3>43</e3>
			</tdml:dfdlInfoset>
		</tdml:infoset>
	</tdml:parserTestCase>
	
	<tdml:parserTestCase name="discrimPatternFail2"
		root="e3" model="s1" description="Section 7 - multiple discrim as a pattern - DFDL-7-045R">
		<tdml:document><![CDATA[43,]]></tdml:document>
		<tdml:errors>
			<tdml:error>Discrim</tdml:error>
			<tdml:error>pattern</tdml:error>
		</tdml:errors>
	</tdml:parserTestCase>
	
	<tdml:parserTestCase name="discrimPatternFail3"
		root="e4" model="s1" description="Section 7 - multiple discrim as a pattern, verify failed discrim 
		is not set to true with subsequent success - DFDL-7-045R">
		<tdml:document><![CDATA[43,]]></tdml:document>
		<tdml:errors>
			<tdml:error>Discrim</tdml:error>
			<tdml:error>pattern</tdml:error>
		</tdml:errors>
	</tdml:parserTestCase>
	
	<tdml:parserTestCase name="discrimPatternFail4"
		root="e5" model="s1" description="Section 7 - verify discrim still called even when asserts present - DFDL-7-045R">
		<tdml:document><![CDATA[43,]]></tdml:document>
		<tdml:errors>
			<tdml:error>Discrim</tdml:error>
			<tdml:error>pattern</tdml:error>
		</tdml:errors>
	</tdml:parserTestCase>
	
	<tdml:parserTestCase name="discrimPatternFail5"
		root="e5" model="s1" description="Section 7 - verify discrim still called even when asserts present - DFDL-7-045R">
		<tdml:document><![CDATA[4,]]></tdml:document>
		<tdml:errors>
			<tdml:error>Discrim</tdml:error>
			<tdml:error>pattern</tdml:error>
		</tdml:errors>
	</tdml:parserTestCase>
	
	<tdml:parserTestCase name="discrimPatternFail6"
		root="e6" model="s1" description="Section 7 - verify test fails even when discrim is true but assert is false - DFDL-7-045R">
		<tdml:document><![CDATA[44:]]></tdml:document>
		<tdml:errors>
			<tdml:error>Assert</tdml:error>
			<tdml:error>pattern</tdml:error>
		</tdml:errors>
	</tdml:parserTestCase>

</tdml:testSuite>
