<?xml version="1.0" encoding="UTF-8"?>
<tdml:testSuite xmlns:tdml="http://www.ibm.com/xmlns/dfdl/testData"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:dfdl="http://www.ogf.org/dfdl/dfdl-1.0/"
  xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ex="http://example.com">

  <tdml:defineSchema name="SequenceGroup-Embedded.dfdl.xsd">
    <dfdl:format ref="ex:daffodilTest1" lengthUnits="bytes"
      lengthKind="implicit" />
    <xs:element name="SG_05">
      <xs:complexType>
        <xs:sequence>
          <xs:element name="e1" type="xs:int"
            dfdl:lengthKind="explicit" dfdl:length="3" />
          <xs:element name="e2" type="xs:float"
            dfdl:lengthKind="explicit" dfdl:length="5" />
          <xs:element name="e3" type="xs:long"
            dfdl:lengthKind="explicit" dfdl:length="4" />
          <xs:element name="leftover" type="xs:string"
            dfdl:lengthKind="delimited" />
        </xs:sequence>
      </xs:complexType>
    </xs:element>
  </tdml:defineSchema>

  <tdml:parserTestCase name="SeqGrp_05"
    model="SequenceGroup-Embedded.dfdl.xsd" description="Section 14 Sequence group with left over data - DFDL-14-001R"
    root="SG_05">
    <tdml:document><![CDATA[837742.8-1197108]]></tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <SG_05>
          <e1>837</e1>
          <e2>742.8</e2>
          <e3>-119</e3>
          <leftover>7108</leftover>
        </SG_05>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:defineSchema name="hiddenGroup1">
    <dfdl:format ref="ex:daffodilTest1" lengthKind="delimited" />
    <xs:group name="hg">
      <xs:sequence>
        <xs:element name="f" type="xs:int" />
      </xs:sequence>
    </xs:group>
    <xs:element name="e" dfdl:lengthKind="delimited">
      <xs:complexType>
        <xs:sequence dfdl:separator=",">
          <xs:sequence dfdl:hiddenGroupRef="ex:hg" />
          <xs:element name="g" type="xs:int" />
        </xs:sequence>
      </xs:complexType>
    </xs:element>
  </tdml:defineSchema>

  <tdml:parserTestCase name="hiddenGroup1" root="e"
    model="hiddenGroup1" description="Unit test of hidden group ref.">
    <tdml:document>
      <tdml:documentPart type="text"><![CDATA[1,2]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e>
          <g>2</g>
        </e>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:defineSchema name="hiddenGroup2">
    <dfdl:format ref="ex:daffodilTest1" lengthKind="delimited" />
    <xs:group name="hg">
      <xs:sequence>
        <xs:element name="f" type="xs:int" />
      </xs:sequence>
    </xs:group>
    <xs:element name="e" dfdl:lengthKind="delimited">
      <xs:complexType>
        <xs:sequence dfdl:separator=",">
          <xs:sequence dfdl:hiddenGroupRef="ex:hg">
            <xs:element name="x" type="xs:int" />
          </xs:sequence>
          <xs:element name="g" type="xs:int" />
        </xs:sequence>
      </xs:complexType>
    </xs:element>
  </tdml:defineSchema>
  
  <tdml:parserTestCase name="hiddenGroupSchemaFail" root="e"
    model="hiddenGroup2" description="Unit test of hidden group ref.">
    <tdml:document>
      <tdml:documentPart type="text"><![CDATA[1,2]]></tdml:documentPart>
    </tdml:document>
    <tdml:errors>
      <tdml:error />
    </tdml:errors>
  </tdml:parserTestCase>
  
  <tdml:defineSchema name="hiddenGroup3">
    <dfdl:format ref="ex:daffodilTest1" lengthKind="delimited" />

    <xs:group name="hg">
      <xs:sequence>
        <xs:element name="f" type="xs:int">
          <xs:annotation>
            <xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
              <dfdl:assert><![CDATA[{ xs:int(.) eq 42 }]]></dfdl:assert>
            </xs:appinfo>
          </xs:annotation>
        </xs:element>
      </xs:sequence>
    </xs:group>
    <xs:element name="e" dfdl:lengthKind="delimited">
      <xs:complexType>
        <xs:sequence dfdl:separator=",">
          <xs:sequence dfdl:hiddenGroupRef="ex:hg" />
          <xs:element name="g" type="xs:int" />
        </xs:sequence>
      </xs:complexType>
    </xs:element>
  </tdml:defineSchema>
  
  <!--
    Test name: hiddenGroupWithAssert
       Schema: hiddenGroup3
      Purpose: This test demonstrates that hidden groups can contain regular DFDL annotations.
  -->
  
  <tdml:parserTestCase name="hiddenGroupWithAssert" root="e"
    model="hiddenGroup3" description="Section 14 - Hidden Elements DFDL-14-037R.">
    <tdml:document>
      <tdml:documentPart type="text"><![CDATA[42,2]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e>
          <g>2</g>
        </e>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <!--
    Test name: hiddenGroupWithAssert2
       Schema: hiddenGroup3
      Purpose: This test demonstrates that hidden groups can contain regular DFDL annotations.
  -->
  
  <tdml:parserTestCase name="hiddenGroupWithAssert2" root="e"
    model="hiddenGroup3" description="Section 14 - Hidden Elements DFDL-14-037R.">
    <tdml:document>
      <tdml:documentPart type="text"><![CDATA[43,2]]></tdml:documentPart>
    </tdml:document>
    <tdml:errors>
      <tdml:error>Assertion failed</tdml:error>
    </tdml:errors>
  </tdml:parserTestCase>
  
  <tdml:defineSchema name="hiddenGroup4">
    <dfdl:format ref="ex:daffodilTest1" lengthKind="delimited" />
    <xs:group name="hgNested">
      <xs:sequence>
        <xs:element name="sneaky" type="xs:int" />
      </xs:sequence>
    </xs:group>
    <xs:group name="hg">
      <xs:sequence dfdl:separator="/">
        <xs:sequence dfdl:hiddenGroupRef="ex:hgNested" />
        <xs:element name="f" type="xs:int" />
      </xs:sequence>
    </xs:group>
    <xs:element name="e" dfdl:lengthKind="delimited">
      <xs:complexType>
        <xs:sequence dfdl:separator=",">
          <xs:sequence dfdl:hiddenGroupRef="ex:hg" />
          <xs:element name="g" type="xs:int" />
        </xs:sequence>
      </xs:complexType>
    </xs:element>
    
    <xs:group name="hgNested3">
      <xs:sequence>
        <xs:element name="sneakier" type="xs:int" />
      </xs:sequence>
    </xs:group>
    <xs:group name="hgNested2">
      <xs:sequence dfdl:separator="o">
        <xs:sequence dfdl:hiddenGroupRef="ex:hgNested3" />
        <xs:element name="sneaky" type="xs:int" />
      </xs:sequence>
    </xs:group>
    <xs:group name="hg2">
      <xs:sequence dfdl:separator="/">
        <xs:sequence dfdl:hiddenGroupRef="ex:hgNested2" />
        <xs:element name="f" type="xs:int" />
      </xs:sequence>
    </xs:group>

    <xs:element name="ee" dfdl:lengthKind="delimited">
      <xs:complexType>
        <xs:sequence dfdl:separator=",">
          <xs:sequence dfdl:hiddenGroupRef="ex:hg2" />
          <xs:element name="g" type="xs:int" />
        </xs:sequence>
      </xs:complexType>
    </xs:element>
  </tdml:defineSchema>
  
  <!--
    Test name: hiddenGroupNested
       Schema: hiddenGroup4
      Purpose: This test demonstrates that hidden groups can contain other hidden groups
  -->
  
  <tdml:parserTestCase name="hiddenGroupNested" root="e"
    model="hiddenGroup4" description="Section 14 - Hidden Elements - DFDL-14-041R.">
    <tdml:document>
      <tdml:documentPart type="text"><![CDATA[5/42,2]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e>
          <g>2</g>
        </e>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <!--
    Test name: hiddenGroupNested2
       Schema: hiddenGroup4
      Purpose: This test demonstrates that hidden groups can contain other hidden groups
  -->
  
  <tdml:parserTestCase name="hiddenGroupNested2" root="ee"
    model="hiddenGroup4" description="Section 14 - Hidden Elements - DFDL-14-041R.">
    <tdml:document>
      <tdml:documentPart type="text"><![CDATA[6o5/42,2]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <ee>
          <g>2</g>
        </ee>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>

  <tdml:parserTestCase name="AS000" root="table" model="AS-Embedded"
    description="hiddenGroupRef">
    <tdml:document><![CDATA[Creator: NCSA
Date: Mon Feb 23 15:20:47 CST 2009
0,1,2,3,4,5,6,7,8,9
1,2,3,4,5,6,7,8,9,10
2,3,4,5,6,7,8,9,10,11
3,4,5,6,7,8,9,10,11,12
4,5,6,7,8,9,10,11,12,13
5,6,7,8,9,10,11,12,13,14
6,7,8,9,10,11,12,13,14,15
7,8,9,10,11,12,13,14,15,16
8,9,10,11,12,13,14,15,16,17
9,10,11,12,13,14,15,16,17,18
]]></tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <table>
          <matrix>
            <row>
              <cell type="xs:int">0</cell>
              <cell type="xs:int">1</cell>
              <cell type="xs:int">2</cell>
              <cell type="xs:int">3</cell>
              <cell type="xs:int">4</cell>
              <cell type="xs:int">5</cell>
              <cell type="xs:int">6</cell>
              <cell type="xs:int">7</cell>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
            </row>
            <row>
              <cell type="xs:int">1</cell>
              <cell type="xs:int">2</cell>
              <cell type="xs:int">3</cell>
              <cell type="xs:int">4</cell>
              <cell type="xs:int">5</cell>
              <cell type="xs:int">6</cell>
              <cell type="xs:int">7</cell>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
            </row>
            <row>
              <cell type="xs:int">2</cell>
              <cell type="xs:int">3</cell>
              <cell type="xs:int">4</cell>
              <cell type="xs:int">5</cell>
              <cell type="xs:int">6</cell>
              <cell type="xs:int">7</cell>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
              <cell type="xs:int">11</cell>
            </row>
            <row>
              <cell type="xs:int">3</cell>
              <cell type="xs:int">4</cell>
              <cell type="xs:int">5</cell>
              <cell type="xs:int">6</cell>
              <cell type="xs:int">7</cell>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
              <cell type="xs:int">11</cell>
              <cell type="xs:int">12</cell>
            </row>
            <row>
              <cell type="xs:int">4</cell>
              <cell type="xs:int">5</cell>
              <cell type="xs:int">6</cell>
              <cell type="xs:int">7</cell>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
              <cell type="xs:int">11</cell>
              <cell type="xs:int">12</cell>
              <cell type="xs:int">13</cell>
            </row>
            <row>
              <cell type="xs:int">5</cell>
              <cell type="xs:int">6</cell>
              <cell type="xs:int">7</cell>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
              <cell type="xs:int">11</cell>
              <cell type="xs:int">12</cell>
              <cell type="xs:int">13</cell>
              <cell type="xs:int">14</cell>
            </row>
            <row>
              <cell type="xs:int">6</cell>
              <cell type="xs:int">7</cell>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
              <cell type="xs:int">11</cell>
              <cell type="xs:int">12</cell>
              <cell type="xs:int">13</cell>
              <cell type="xs:int">14</cell>
              <cell type="xs:int">15</cell>
            </row>
            <row>
              <cell type="xs:int">7</cell>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
              <cell type="xs:int">11</cell>
              <cell type="xs:int">12</cell>
              <cell type="xs:int">13</cell>
              <cell type="xs:int">14</cell>
              <cell type="xs:int">15</cell>
              <cell type="xs:int">16</cell>
            </row>
            <row>
              <cell type="xs:int">8</cell>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
              <cell type="xs:int">11</cell>
              <cell type="xs:int">12</cell>
              <cell type="xs:int">13</cell>
              <cell type="xs:int">14</cell>
              <cell type="xs:int">15</cell>
              <cell type="xs:int">16</cell>
              <cell type="xs:int">17</cell>
            </row>
            <row>
              <cell type="xs:int">9</cell>
              <cell type="xs:int">10</cell>
              <cell type="xs:int">11</cell>
              <cell type="xs:int">12</cell>
              <cell type="xs:int">13</cell>
              <cell type="xs:int">14</cell>
              <cell type="xs:int">15</cell>
              <cell type="xs:int">16</cell>
              <cell type="xs:int">17</cell>
              <cell type="xs:int">18</cell>
            </row>
          </matrix>
        </table>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:defineSchema name="AS-Embedded">
    <dfdl:format ref="ex:daffodilTest1"
          lengthKind="delimited" separator=""
          leadingSkip='0' encoding="US-ASCII" ignoreCase='no' initiator=""
          terminator="" initiatedContent="no" textNumberRep="standard"
          separatorPolicy="suppressedAtEndLax" separatorPosition="infix"
          documentFinalTerminatorCanBeMissing='yes' textTrimKind="none"/>

  <!-- CSV with metadata header, remove header -->

  <xs:element name="matrix" type="ex:matrixType" />
  <xs:element name="table" type="ex:SimpleTable" />

  <xs:group name="hdrGroup">
    <xs:sequence>
      <xs:element name="hdrblock" type="ex:header" />
    </xs:sequence>
  </xs:group>

  <xs:complexType name="SimpleTable">
    <xs:sequence>
      <xs:sequence dfdl:hiddenGroupRef="ex:hdrGroup" />
      <xs:element name="matrix" type="ex:matrixType" />
    </xs:sequence>
  </xs:complexType>

  <xs:complexType name="header">
    <xs:sequence>
      <xs:element name="Creator" type="xs:string" dfdl:terminator="%NL;"
        dfdl:initiator="Creator:" dfdl:encoding="ASCII"
        dfdl:representation="text" dfdl:lengthKind="delimited" />
      <xs:element name="Date" type="xs:string" dfdl:terminator="%NL;"
        dfdl:initiator="Date:" dfdl:encoding="ASCII"
        dfdl:representation="text" />
    </xs:sequence>
  </xs:complexType>

  <xs:complexType name="matrixType">
    <xs:sequence>
      <xs:element name="row" maxOccurs="unbounded" dfdl:occursCountKind='parsed'>
        <xs:complexType>
          <xs:sequence dfdl:separator="," dfdl:terminator="%NL;"
            dfdl:separatorPolicy="suppressed" dfdl:separatorPosition="infix">
            <xs:element name="cell" type="xs:int" maxOccurs="unbounded"
              dfdl:occursCountKind='parsed'
              dfdl:encoding="ASCII" dfdl:representation="text"
              dfdl:lengthKind="delimited" />
          </xs:sequence>
        </xs:complexType>
      </xs:element>
    </xs:sequence>
  </xs:complexType>

  </tdml:defineSchema>
  
  <tdml:defineSchema name="AD-Embedded">
    <dfdl:format ref="ex:daffodilTest1" 
        lengthKind="delimited" separator=""
        leadingSkip='0' encoding="US-ASCII" ignoreCase='no' initiator=""
        terminator="" initiatedContent="no" textNumberRep="standard"
        separatorPolicy="suppressed" separatorPosition="infix"
        occursCountKind="parsed" textTrimKind="none"/>

  <!-- Evaluated occursCount based on hidden elements -->

  <xs:group name="xCountGroup">
    <xs:sequence>
      <xs:element name="xCount" type="xs:int" dfdl:representation="text" />
    </xs:sequence>
  </xs:group>

  <xs:group name="yCountGroup">
    <xs:sequence>
      <xs:element name="yCount" type="xs:int" dfdl:representation="text" />
    </xs:sequence>
  </xs:group>

  <xs:element name="list">
    <xs:complexType>
      <xs:sequence>
        <xs:sequence dfdl:separator="%NL;" dfdl:separatorPosition="postfix">
          <xs:sequence dfdl:hiddenGroupRef="ex:xCountGroup" />
          <xs:element name="x" type="xs:string" maxOccurs="unbounded"
            dfdl:occursCountKind="expression" dfdl:occursCount="{ ../ex:xCount }"
            dfdl:representation="text" />
          <xs:sequence dfdl:hiddenGroupRef="ex:yCountGroup" />
          <xs:element name="y" type="xs:string" maxOccurs="unbounded"
            dfdl:occursCountKind="expression" dfdl:occursCount="{ ../ex:yCount }"
            dfdl:representation="text" />
        </xs:sequence>
        <xs:sequence dfdl:hiddenGroupRef="ex:leftOver" />
      </xs:sequence>
    </xs:complexType>
  </xs:element>

  <xs:group name="leftOver">
    <xs:sequence>
      <xs:element name="leftOver" type="xs:string" />
    </xs:sequence>
  </xs:group>
  </tdml:defineSchema>
  
  <tdml:parserTestCase name="AD000" root="list" model="AD-Embedded"
    description="occursCount with expressions">
    <tdml:document><![CDATA[3
first x
second x
third x
5
first y
second y
third y
fourth y
fifth y
ignored input
more ignored input
]]></tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <list>
          <x type="xs:string">first x</x>
          <x type="xs:string">second x</x>
          <x type="xs:string">third x</x>
          <y type="xs:string">first y</y>
          <y type="xs:string">second y</y>
          <y type="xs:string">third y</y>
          <y type="xs:string">fourth y</y>
          <y type="xs:string">fifth y</y>
        </list>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:defineSchema name="AC-Embedded">
    <dfdl:format ref="ex:daffodilTest1"
        lengthKind="delimited" separator=""
        leadingSkip='0' encoding="US-ASCII" ignoreCase='no' initiator=""
        terminator="" initiatedContent="no" textNumberRep="standard"
        separatorPolicy="suppressed" separatorPosition="infix"
        occursCountKind="parsed" textTrimKind="none"/>

  <!-- Parsing values as a hidden layer, then
    creating elements by evaluating XPath expressions on the layer -->

  <xs:group name="data">
    <xs:sequence dfdl:separator="">
      <xs:element name="x" type="int" dfdl:representation="text"
        dfdl:terminator="%NL;" />
      <xs:element name="y" type="int" dfdl:representation="text"
        dfdl:terminator="%NL;" />
      <xs:element name="z" type="int" dfdl:representation="text"
        dfdl:terminator="%NL;" />
    </xs:sequence>
  </xs:group>

  <xs:element name="table">
    <xs:complexType>
      <xs:sequence>
        <xs:sequence dfdl:hiddenGroupRef="ex:data" />
        <xs:element name="product" type="int"
          dfdl:inputValueCalc="{ /ex:table/ex:x * /ex:table/ex:y * /ex:table/ex:z }" />
        <xs:element name="sum" type="int"
          dfdl:inputValueCalc="{ /ex:table/ex:x + /ex:table/ex:y + /ex:table/ex:z }" />
        <xs:element name="concat" type="string"
          dfdl:inputValueCalc="{ concat(concat(/ex:table/ex:x,/ex:table/ex:y),/ex:table/ex:z) }" />
        <xs:element name="x" type="string" dfdl:inputValueCalc="{ ../ex:x }" />
        <xs:element name="y" type="string" dfdl:inputValueCalc="{ ../ex:y }" />
        <xs:element name="z" type="string" dfdl:inputValueCalc="{ ../ex:z }" />
        <xs:element name="productAgain" type="string"
          dfdl:inputValueCalc="{ ../ex:product }" />
      </xs:sequence>
    </xs:complexType>
  </xs:element>
  </tdml:defineSchema>
  
  <tdml:parserTestCase name="AC000" root="table" model="AC-Embedded"
    description="inputValueCalc expressions and hiddenGroupRef">
    <tdml:document><![CDATA[10
20
30
]]></tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <table>
          <product type="xs:int">6000</product>
          <sum type="xs:int">60</sum>
          <concat type="xs:string">102030</concat>
          <x type="xs:string">10</x>
          <y type="xs:string">20</y>
          <z type="xs:string">30</z>
          <productAgain type="xs:string">6000</productAgain>
        </table>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>

</tdml:testSuite>
