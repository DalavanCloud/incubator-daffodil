<?xml version="1.0" encoding="UTF-8"?>
<tdml:testSuite suiteName="binaryInput"
  description="Section 13 - Simple Types of Binary Format" xmlns:tdml="http://www.ibm.com/xmlns/dfdl/testData"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:dfdl="http://www.ogf.org/dfdl/dfdl-1.0/"
  xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:tns="http://example.com"
  xsi:schemaLocation="http://www.ibm.com/xmlns/dfdl/testData /xsd/tdml.xsd">

  <tdml:defineSchema name="DFDL-307-one-octet.dfdl.xsd">

    <dfdl:format ref="tns:daffodilTest1" representation="binary"
      binaryNumberRep="binary" lengthUnits="bits" byteOrder='bigEndian'
      alignment="1" alignmentUnits="bits" lengthKind='explicit' />

    <xs:element name="is-signed" dfdl:lengthKind="implicit">
      <xs:complexType>
        <xs:sequence>
          <xs:element name="sign" type="xs:unsignedByte"
            dfdl:length="1" />
          <xs:element name="abs" type="xs:unsignedByte"
            dfdl:length="7" />
        </xs:sequence>
      </xs:complexType>
    </xs:element>

    <xs:element name="e1" type="xs:unsignedByte" dfdl:length="1" />

    <xs:element name="e2">
      <xs:complexType>
        <xs:sequence>
          <xs:element name="others" type="xs:unsignedInt"
            dfdl:length="7" />
          <xs:element name="v" type="xs:unsignedByte"
            dfdl:length="1" />

        </xs:sequence>
      </xs:complexType>
    </xs:element>

  </tdml:defineSchema>

  <tdml:parserTestCase name="OneOctetBinaryParse"
    root="is-signed" model="DFDL-307-one-octet.dfdl.xsd" description="Section 13 - Simple Types of Binary Format">
    <tdml:document>
      <tdml:documentPart type="bits">00110000
      </tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset xmlns:xs="http://www.w3.org/2001/XMLSchema"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
        <is-signed>
          <sign>0</sign>
          <abs>48</abs>
        </is-signed>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>

  <tdml:parserTestCase name="OneBit2" root="e2"
    model="DFDL-307-one-octet.dfdl.xsd" description="Section 13 - Simple Types of Binary Format">
    <tdml:document>
      <tdml:documentPart type="bits">00000001
      </tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e2>
          <others>0</others>
          <v>1</v>
        </e2>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:defineSchema name="packed7BitASCII">
  
  <dfdl:format ref="tns:daffodilTest1"
     encoding="US-ASCII-7-bit-packed" lengthUnits="characters"/>
     
  <xs:element name="e1" type="xs:string" dfdl:lengthKind="explicit" dfdl:length="2"/>
  <xs:element name="e2" type="xs:string" dfdl:lengthKind="explicit" dfdl:length="64"/>
  <xs:element name="e3" type="xs:string" dfdl:lengthKind="delimited" dfdl:terminator=","/>
  
  <xs:element name="e4">
    <xs:complexType>
    <xs:choice>
    <!-- Using a choice here works for parsing, but is very challenging for unparsing.
    We really don't want a choice here we want one element. See other examples/tests 
    for alternative techniques. -->
      <xs:element name="d0" type="xs:string" dfdl:terminator="%NUL;" dfdl:lengthKind="delimited">
       <xs:annotation>
       <xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
         <!-- 0 to 4 occurrences of not a NUL, followed by a NUL -->
         <dfdl:discriminator testKind="pattern">[^\x00]{0,3}\x00</dfdl:discriminator>
       </xs:appinfo>
       </xs:annotation>
      </xs:element>
      <xs:element name="d1" type="xs:string" dfdl:lengthKind="explicit" dfdl:length="4"/>
    </xs:choice>
    </xs:complexType>
  </xs:element>
  

  <!-- Superior alternative for dealing with termination that uses
    a fixed max length OR a terminator if the string is shorter than the maximum -->
  <xs:element name="e5">
    <xs:complexType>
      <xs:sequence>
        <xs:element name="s" type="xs:string"
          dfdl:lengthKind="pattern">
          <xs:annotation>
            <xs:appinfo source="http://www.ogf.org/dfdl/dfdl-1.0/">
              <!-- 0 to 4 occurrences of not a 0x7F, followed by a 0x7F -->
              <dfdl:element>
                <dfdl:property name="lengthPattern"><![CDATA[([^\x7F]{0,3})(?=\x7F)|[^\x7F]{4}]]></dfdl:property>
              </dfdl:element>
            </xs:appinfo>
          </xs:annotation>
        </xs:element>
        <xs:group ref="tns:hidden_group1" /> <!-- should be hidden, but that feature not yet implemented -->
      </xs:sequence>
    </xs:complexType>
  </xs:element>

  <xs:group name="hidden_group1">
    <xs:sequence>
      <xs:element name="term" type="xs:string"
        dfdl:lengthKind="explicit" dfdl:length="0" dfdl:initiator="&#x7F;"
        minOccurs="0" maxOccurs="1" dfdl:occursCountKind="expression"
        dfdl:occursCount="{ fn:string-length(../tns:s) lt 4 }" />
    </xs:sequence>
  </xs:group>
    
  </tdml:defineSchema>

<tdml:parserTestCase name="packed7BitASCII1" root="e1"
    model="packed7BitASCII">
    <tdml:document>
      <tdml:documentPart type="bits"><![CDATA[
      0110100 0110010
      ]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e1>42</e1>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:parserTestCase name="packed7BitASCII2" root="e2"
    model="packed7BitASCII">
    <tdml:document>
      <tdml:documentPart type="bits"><![CDATA[
      0110001 0110010 0110011 0110100 0110101 0110110 0110111 0111000 0111001 0110000
      0110001 0110010 0110011 0110100 0110101 0110110 0110111 0111000 0111001 0110000
      0110001 0110010 0110011 0110100 0110101 0110110 0110111 0111000 0111001 0110000
      0110001 0110010 0110011 0110100 0110101 0110110 0110111 0111000 0111001 0110000
      0110001 0110010 0110011 0110100 0110101 0110110 0110111 0111000 0111001 0110000
      0110001 0110010 0110011 0110100 0110101 0110110 0110111 0111000 0111001 0110000
      0110001 0110010 0110011 0110100 
      ]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e2>1234567890123456789012345678901234567890123456789012345678901234</e2>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:parserTestCase name="packed7BitASCII3" root="e3"
    model="packed7BitASCII">
    <tdml:document>
      <tdml:documentPart type="bits"><![CDATA[
      0110001 0101100 
      ]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e3>1</e3>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  
    <tdml:parserTestCase name="packed7BitASCII4" root="e4"
    model="packed7BitASCII">
    <tdml:document>
      <tdml:documentPart type="bits"><![CDATA[
      0110001 0000000 
      ]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e4><d0>1</d0></e4>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  
  <tdml:parserTestCase name="packed7BitASCII5" root="e4"
    model="packed7BitASCII">
    <tdml:document>
      <tdml:documentPart type="bits"><![CDATA[
      0110001 0110010 0110011 0110100 
      ]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e4><d1>1234</d1></e4>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:parserTestCase name="packed7BitASCII6" root="e4"
    model="packed7BitASCII">
    <tdml:document>
      <tdml:documentPart type="bits"><![CDATA[
      0110001 0110010 0110011 0000000 
      ]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e4><d0>123</d0></e4>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:parserTestCase name="packed7BitASCII7" root="e5"
    model="packed7BitASCII">
    <tdml:document>
      <tdml:documentPart type="bits"><![CDATA[
      0110001 0110010 0110011 0110100 
      ]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e5><s>1234</s></e5>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  <tdml:parserTestCase name="packed7BitASCII8" root="e5"
    model="packed7BitASCII">
    <tdml:document>
      <tdml:documentPart type="bits"><![CDATA[
      0110001 0110010 0110011 1111111 
      ]]></tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <e5><s>123</s><term/></e5> <!-- term should be hidden once that feature is implemented. -->
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>
  
  
  
</tdml:testSuite>
